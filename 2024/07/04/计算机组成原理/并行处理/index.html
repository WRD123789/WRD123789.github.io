

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="并行处理 并行处理是运行两个或多个处理器来处理整个任务的不同部分的一种计算方法. 原因  CPU 时钟速率难以提升  技术和经济挑战. 先进的冷却技术过于昂贵   并行处理是提高速度的唯一途径.  两种基本并行方式  多道程序设计  并行运行多个独立的程序   并行计算  让一个程序分布在多个运算元件上来加快该程序的运行速度.    Flynn 分类法 Flynn 是一种计算系统分类法. 它将计算">
<meta property="og:type" content="article">
<meta property="og:title" content="并行处理">
<meta property="og:url" content="http://example.com/2024/07/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="并行处理 并行处理是运行两个或多个处理器来处理整个任务的不同部分的一种计算方法. 原因  CPU 时钟速率难以提升  技术和经济挑战. 先进的冷却技术过于昂贵   并行处理是提高速度的唯一途径.  两种基本并行方式  多道程序设计  并行运行多个独立的程序   并行计算  让一个程序分布在多个运算元件上来加快该程序的运行速度.    Flynn 分类法 Flynn 是一种计算系统分类法. 它将计算">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/Pictures/20221118140244.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118140518.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118171500.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118171624.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118140746.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118140907.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118221928.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118222034.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118222418.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118222431.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118223532.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118224235.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118225028.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118231503.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118231628.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118231707.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221118231731.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221119142244.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221119174629.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221119193825.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221120142857.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221120132321.png">
<meta property="og:image" content="http://example.com/img/Pictures/20221120133640.png">
<meta property="article:published_time" content="2024-07-04T05:24:18.000Z">
<meta property="article:modified_time" content="2024-07-04T13:37:06.508Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="计算机组成原理">
<meta property="article:tag" content="CS61C">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/Pictures/20221118140244.png">
  
  
  
  <title>并行处理 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wangrd&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="并行处理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-07-04 13:24" pubdate>
          2024年7月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          35 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">并行处理</h1>
            
            
              <div class="markdown-body">
                
                <h1>并行处理</h1>
<p>并行处理是运行两个或多个处理器来处理整个任务的不同部分的一种计算方法.</p>
<p>原因</p>
<ul>
<li>CPU 时钟速率难以提升
<ul>
<li>技术和经济挑战.</li>
<li>先进的冷却技术过于昂贵</li>
</ul>
</li>
<li>并行处理是提高速度的唯一途径.</li>
</ul>
<p>两种基本并行方式</p>
<ul>
<li>多道程序设计
<ul>
<li>并行运行多个独立的程序</li>
</ul>
</li>
<li>并行计算
<ul>
<li>让一个程序分布在多个运算元件上来加快该程序的运行速度.</li>
</ul>
</li>
</ul>
<h2 id="Flynn-分类法">Flynn 分类法</h2>
<p>Flynn 是一种计算系统分类法. 它将计算机体系结构根据数据流和指令流划分为四类:</p>
<ul>
<li>
<p>单指令/单数据流 (SISD)</p>
<ul>
<li>为了进行分类, 我们将计算机体系结构抽象为数据池、指令池和处理单元.</li>
<li>在 SISD 中, 每次从指令池中提取一条指令, 从数据池中提取一个数据单元, 然后将指令和数据单元发送到处理单元中执行.</li>
<li><img src="/img/Pictures/20221118140244.png" srcset="/img/loading.gif" lazyload alt=""></li>
<li>可以将指令看作函数, 将数据单元看作函数的输入. 在硬件中, 我们获取程序计数器指向的指令, 将数据加载到寄存器中, 处理器在寄存器上执行指令.</li>
</ul>
</li>
<li>
<p>单指令/多数据流 (SIMD)</p>
<ul>
<li>在 SIMD 中, 在每个步骤中, 我们从指令池中提取一条指令, 从数据池中提取多个数据单元, 并将指令和每个数据单元发送到一个处理单元中执行.</li>
<li><img src="/img/Pictures/20221118140518.png" srcset="/img/loading.gif" lazyload alt=""></li>
<li>在硬件中, 我们获取程序计数器指向的指令, 将多个数据加载到宽寄存器中 (一个宽寄存器可以包含多个整数或多个浮点数), 处理器并行执行寄存器上的指令. (其中处理单元不必是独立的核心, SIMD 可以在单个核内工作, 一条指令可以并行地应用于单个核内的多个数据单元).</li>
<li>例如: C = A + B
<ul>
<li>
<p>对于 SISD 而言, 每次获取一对 A 和 B, 并对该对元素应用加法指令, 以下为 4 步后的结果:</p>
<p><img src="/img/Pictures/20221118171500.png" srcset="/img/loading.gif" lazyload alt=""></p>
</li>
<li>
<p>对于 SIMD 而言, 每次获取多对 A 和 B, 并行地对每一对元素应用加法指令, 以下为 1 步后的结果:</p>
<p><img src="/img/Pictures/20221118171624.png" srcset="/img/loading.gif" lazyload alt=""></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>多指令/多数据流 (MIMD)</p>
<ul>
<li>对于 MIMD, 每次从数据池中提取多个数据单元, 从指令池中提取多个指令, 并将每个数据单元和指令发送到处理单元中并行地执行.</li>
<li><img src="/img/Pictures/20221118140746.png" srcset="/img/loading.gif" lazyload alt=""></li>
<li>在硬件中, 多核心中的每个核心都获取指令和数据, 并行地执行指令.</li>
</ul>
</li>
<li>
<p>多指令/单数据流 (MISD)</p>
<ul>
<li>用多个指令流处理一个数据流.</li>
<li><img src="/img/Pictures/20221118140907.png" srcset="/img/loading.gif" lazyload alt=""></li>
<li>较少用到, 不考虑.</li>
</ul>
</li>
</ul>
<p>如果有个适合 MIMD 操作的计算结构, 那也可以处理 SIMD 问题, 所以 SIMD 有利的问题可以很容易映射到 MIMD 型计算结构上; 但是适合 MIMD 的问题不容易映射到 SIMD 型计算结构上.</p>
<p>SIMD 结构相较于 MIMD 结构通常具有更简单的控制逻辑和更高的性能.</p>
<h2 id="数据级并行">数据级并行</h2>
<p>数据级并行是计算机处理的一种方法, 其目的是通过同时操作多个数据元素来提高数据吞吐量.</p>
<p>例如:</p>
<p>SIMD 对宽寄存器 (也叫向量) 进行操作:</p>
<p><img src="/img/Pictures/20221118221928.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="/img/Pictures/20221118222034.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="x86-SIMD-Intrinsics">x86 SIMD Intrinsics</h3>
<p>Intrinsics: 从 C 语言直接访问汇编</p>
<p><img src="/img/Pictures/20221118222418.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="/img/Pictures/20221118222431.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>Intel Intrinsics Guide:<br>
<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html</a></p>
<p>Intrinsics Gudie:<br>
<a target="_blank" rel="noopener" href="https://www.cs.virginia.edu/~cr4bd/3330/S2018/simdref.html">https://www.cs.virginia.edu/~cr4bd/3330/S2018/simdref.html</a></p>
<p>命名和使用语法:<br>
<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/naming-and-usage-syntax.html">https://www.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/naming-and-usage-syntax.html</a></p>
<h3 id="优化-dgemm">优化 dgemm</h3>
<p>这是一个根据数据级并行优化双精度浮点数通用矩阵乘法 (dgemm)的例子</p>
<p>该乘法在 Python 中的代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dgemm</span>(<span class="hljs-params">N, a, b, c</span>):<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>		<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>			c[i + j * N] = <span class="hljs-number">0</span><br>			<span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):<br>				c[i + j * N] += a[i + k * N] * b[k + j * N]<br></code></pre></td></tr></table></figure>
<p>Flop: 浮点数运算 (Floating add, Floating mul)</p>
<p>MFLOP: 每秒一百万次浮点数操作.</p>
<p>Python 中 MFLOP 随 N 增长如下:</p>
<p><img src="/img/Pictures/20221118223532.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>使用 C 语言可以提高性能:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dgemm_scalar</span><span class="hljs-params">(<span class="hljs-type">int</span> N, <span class="hljs-type">double</span> *a, <span class="hljs-type">double</span> *b, <span class="hljs-type">double</span> *c)</span> </span>&#123;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i ++) &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; n; j ++) &#123;<br>			<span class="hljs-type">double</span> cij = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; N; k ++) &#123;<br>				cij += a[i + k * N] * b[k + j * N];<br>			&#125;<br>			c[i + j * N] = cij;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对比 C 和 Python 运行 dgemm:</p>
<p><img src="/img/Pictures/20221118224235.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>虽然有了大幅度提升, 但性能依旧不够.</p>
<p>于是用并行处理替代顺序处理 (用 Intrinsics):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dgemm_avx</span><span class="hljs-params">(<span class="hljs-type">int</span> N, <span class="hljs-type">double</span> *a, <span class="hljs-type">double</span> *b, <span class="hljs-type">double</span> *c)</span> </span>&#123;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">4</span>) &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; N; j ++) &#123;<br>			__m256d c0 = &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; N; k ++) &#123;<br>				c0 = _mm256_add_pd(<br>				c0,<br>				_mm256_mul_pd(<br>				_mm256_load_pd(a + i + k * N),<br>				_mm256_broadcast_sd(b + k + j * N)));<br>			&#125;<br>			_mm256_store_pd(c + i + j * N, c0);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>性能得到进一步提升:</p>
<p><img src="/img/Pictures/20221118225028.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>然而观察内存循环:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; N; k ++) &#123;<br>	c0 = __mm256_add_pd(<br>	c0,<br>	_mm256_mul_pd(<br>	_mm256_load_pd(a + i + k * N),<br>	_mm256_broadcast_sd(b + k + j * N)));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中 add_pd 依赖于 mul_pd, mul_pd 依赖于 load_pd.</p>
<p>而其中指令顺序执行如下:</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">load_pd</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul_pd</span> -&gt;</span> add_pd<br><span class="hljs-function"><span class="hljs-title">load_pd</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul_pd</span> -&gt;</span> add_pd<br><span class="hljs-function"><span class="hljs-title">load_pd</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul_pd</span> -&gt;</span> add_pd<br><span class="hljs-function"><span class="hljs-title">load_pd</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul_pd</span> -&gt;</span> add_pd<br></code></pre></td></tr></table></figure>
<p>此时存在流水线风险中的数据风险.</p>
<p>循环展开 (Loop Unrolling)</p>
<p>循环展开是一种针对数组访问循环体的提高程序性能的技术. 它将循环体展开多遍, 从不同循环内寻找可以重叠执行的指令来挖掘更多的指令级并行性</p>
<ul>
<li>对 SIMD 或超标量多发射指令暴露数据级并行性</li>
<li>将不相关操作混合流水线以减少风险</li>
<li>减少分支预测错误.</li>
</ul>
<p>缺点:</p>
<ul>
<li>代码臃肿, 影响可读性.</li>
<li>有时编译器会自动对代码进行循环展开.</li>
<li>循环展开意味着更多的指令, 会产生更大的程序或影响缓存.</li>
</ul>
<p>例如:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">1</span>) &#123;<br>	x[i] = x[i] + s;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中 x[i] 可以展开为 4 个数据单元.</p>
<p>则, 循环展开后:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">4</span>) &#123;<br>	x[i] = x[i] + s;<br>	x[i + <span class="hljs-number">1</span>] = x[i + <span class="hljs-number">1</span>] + s;<br>	x[i + <span class="hljs-number">2</span>] = x[i + <span class="hljs-number">2</span>] + s;<br>	x[i + <span class="hljs-number">3</span>] = x[i + <span class="hljs-number">3</span>] + s;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对上述代码进行循环展开:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> <span class="hljs-type">int</span> UNROLL = <span class="hljs-number">4</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dgemm_avx</span><span class="hljs-params">(<span class="hljs-type">int</span> N, <span class="hljs-type">double</span> *a, <span class="hljs-type">double</span> *b, <span class="hljs-type">double</span> *c)</span> </span>&#123;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += UNROLL * <span class="hljs-number">4</span>) &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; N; j ++) &#123;<br>			__m256d c[<span class="hljs-number">4</span>];<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; UNROLL; x ++) &#123;<br>				c[x] = _mm256_load_pd(C + i + x * <span class="hljs-number">4</span> + j * n);<br>			&#125;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; N; k ++) &#123;<br>				__m256d b = _mm256_broardcast_sd(B + k + j * n); <span class="hljs-comment">// _mm256_broadcast_sd is loading single value and copying it into all four locations</span><br>				<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; UNROLL; x ++) &#123;<br>					c[x] = _mm256_add_pd(c[x],<br>					_mm256_mul_pd(_mm256_load_pd(A + n * k + x * <span class="hljs-number">4</span> + i), b));<br>				&#125;<br>				<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; UNROLL; x++) &#123;<br>					_mm256_store_pd(C + i + x * <span class="hljs-number">4</span> + j * n, c[x]);<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>调整指令执行的顺序来减少数据风险:</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">load</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">load</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">load</span> -&gt;</span> load<br><span class="hljs-function"><span class="hljs-title">mul</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">mul</span> -&gt;</span> mul<br><span class="hljs-function"><span class="hljs-title">add</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">add</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">add</span> -&gt;</span> add<br></code></pre></td></tr></table></figure>
<p>性能提升如下:</p>
<p><img src="/img/Pictures/20221118231503.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>但是观察发现但 N 超过 480 后, 性能急剧下降.</p>
<p>此时是由于矩阵无法完全放入缓存中, 发生容量未命中.</p>
<p>于是用分块来解决问题:</p>
<p><img src="/img/Pictures/20221118231628.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>此时代码如下:</p>
<p><img src="/img/Pictures/20221118231707.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>最终性能如下:</p>
<p><img src="/img/Pictures/20221118231731.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h2 id="阿姆达尔定律">阿姆达尔定律</h2>
<p>阿姆达尔定律是一个计算机科学界的经验法则, 阐述了对于特定改进的性能提升可能由所使用的改进特征的数量所限制的规则.</p>
<p>假设受改进影响的部分的执行时间比例为 F, 改进部分的加速因子为 S, 程序改进前的执行时间为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">E_{pre}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, 可以用阿姆达尔定律来计算程序改进后的执行时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>c</mi><mi>u</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">E_{cur}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>c</mi><mi>u</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">E_{cur}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>×</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>F</mi><mo stretchy="false">)</mo><mo>+</mo><mfrac><mi>F</mi><mi>S</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E_{pre} \times ((1 - F) + \frac{F}{S})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></p>
<p>则改进前后的加速比为:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>E</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi></mrow></msub><msub><mi>E</mi><mrow><mi>c</mi><mi>u</mi><mi>r</mi></mrow></msub></mfrac><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>F</mi><mo stretchy="false">)</mo><mo>+</mo><mfrac><mi>F</mi><mi>S</mi></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{E_{pre}}{E_{cur}} = \frac{1}{(1 - F) + \frac{F}{S}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4308em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9857em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5073em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5064em;vertical-align:-0.6613em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.5795em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6613em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</p>
<p>阿姆达尔定律常用来代表处理器并行运算之后效率提升的能力.</p>
<p>并行计算中的加速比是用并行前的执行速度和并行后的执行速度之比来表示的.</p>
<p>设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">W_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为不能并行部分所占比重, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">W_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 为并行部分所占比重, p 为处理器数量.</p>
<p>则加速比可以表示为:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>p</mi><mi>e</mi><mi>e</mi><mi>d</mi><mi>u</mi><mi>p</mi><mo>=</mo><mfrac><mn>1</mn><mrow><msub><mi>W</mi><mi>s</mi></msub><mo>+</mo><mfrac><msub><mi>W</mi><mi>p</mi></msub><mi>p</mi></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">Speedup = \frac{1}{W_s + \frac{W_p}{p}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Sp</span><span class="mord mathnormal">ee</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7585em;vertical-align:-0.9134em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.4247em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0933em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.6052em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2306em;"><span style="top:-2.3em;margin-left:-0.1389em;margin-right:0.1em;"><span class="pstrut" style="height:2.5em;"></span><span class="mord mathnormal mtight">p</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3944em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4829em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9134em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<p>注意到当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">p \rightarrow \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span> 时, 加速比的极限为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msub><mi>W</mi><mi>s</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{W_s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2902em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>, 即无论我们如何增加处理器的数量, 加速比都无法高于这个值</p>
<p><img src="/img/Pictures/20221119142244.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>此时非并行部分限制了性能.</p>
<p>还需要确保每个处理器完成相同的工作量, 如果其中一个处理器所分担的工作过多, 那么先完成的处理器不得不等待而浪费时间, 影响性能.</p>
<h2 id="多线程与多核">多线程与多核</h2>
<ul>
<li>硬件多线程:
<ul>
<li>在缓存未命中时, 硬件切换线程以在等待缓存未命中的时候做其他工作.</li>
<li>放入冗余硬件 (多个程序计数器、多个寄存器堆等), 这样就无需保存每个线程的上下文.</li>
<li><img src="/img/Pictures/20221119174629.png" srcset="/img/loading.gif" lazyload alt=""></li>
<li>相比多核拥有更好的利用率.</li>
<li>所有线程共享整数加法器、浮点单元、所有缓存 (L1 I$, L1 D$, L2$, L3$) 和内存控制器.</li>
<li>大约增加了 1% 的硬件, 性能提高了 1.10左右.</li>
</ul>
</li>
<li>多核:
<ul>
<li>仅共享外部缓存 (L2$ 或仅 L3$) 和内存控制器.</li>
<li>大约增加 50% 的硬件, 性能提高了 2 左右.</li>
</ul>
</li>
</ul>
<p>现代机器同时具备两者: 具有多个内核, 每个内核有多个线程.</p>
<p>现代机器通常由大/小核设计, 因为大核虽然性能好, 但是功耗大、需要更多的硅, 但很多时候并不需要高性能, 于是便有了小核, 当需要高性能的时候使用大核, 不需要高性能的时候使用小核来降低能耗.</p>
<h2 id="OpenMP">OpenMP</h2>
<p>OpenMP 是 C 语言的拓展, 用于多线程共享内存.</p>
<p>OpenMP 具有可移植、标准化和易编译的特点.</p>
<p>大多数 C 语言编译器已支持 OpenMP, 使用 OpenMP:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">gcc -fopenmp <span class="hljs-keyword">source</span>.c<br></code></pre></td></tr></table></figure>
<p>优点:</p>
<ul>
<li>利用共享内存, 程序员无需担心数据防止.</li>
<li>编译器指令简单易用.</li>
<li>传统串行代码无需重写.</li>
</ul>
<p>缺点:</p>
<ul>
<li>代码只能在共享内存环境中运行.</li>
<li>编译器必须支持 OpenMP.</li>
<li>当处理器的核数过多时, 优化不明显 (阿姆达尔定律).</li>
</ul>
<p>OpenMP 是一个共享内存模型, 具有显式的线程级并行性.</p>
<p><img src="/img/Pictures/20221119193825.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>OpenMP 程序以单进程 (主线程) 开始, 并按顺序执行, 直到遇到第一个并行区域结构.</p>
<ul>
<li>Fork: 主线程创建一个并行线程队 (用 Pragma 和一个结构来实现并行执行).
<ul>
<li>程序中被并行区域所包围的代码块在各个线程之间并行执行.</li>
</ul>
</li>
<li>Join: 当线程队完成并行区域中的代码块执行时, 它们同步并终止, 只留下主线程.</li>
</ul>
<p>Pragmas 是 C 为语言扩展提供的预处理器机制, 如果编译器无法识别 Pragma, 则会忽略它, 所以即使用无法识别 OpenMP 的编译器编译它, 得到的程序也能正常运行, 只是无法并行.</p>
<p>使用:</p>
<ul>
<li>
<p>需要头文件:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;omp.h&gt;</span></span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p>用于并行化的基本 OpenMP 构建:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel</span><br>&#123;<br>	<span class="hljs-comment">/* code goes here*/</span>  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中大括号必须与 #pragma 分开. 上述代码表示创建合适数量的硬件线程, 每个硬件线程都会执行上述代码行, 当所有硬件线程都完成执行后, 从下面继续. 默认情况下声明的变量是共享的, 如果要为每个线程设置一个私有变量, 可如下声明:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel private (x)</span><br></code></pre></td></tr></table></figure>
<p>上述代码表示为每个线程设置一个独立的变量 x.</p>
</li>
<li>
<p>设置 OpenMP 使用的线程数, 最大为物理上的核数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">×</span></span></span></span> 每个核支持的线程数</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">omp_set_num_threads</span>(x);<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>查看当前使用的线程数</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">num_th = <span class="hljs-built_in">omp_get_num_threads</span>();<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>每个线程由一个唯一的 ID, 查询线程 ID</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">th_ID = <span class="hljs-built_in">omp_get_thread_num</span>();<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>并行 for 循环 (必须是简单的 for 循环, 没有中断之类的)</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; max; i += <span class="hljs-number">1</span>) &#123;<br> zero[i] = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上述代码会将 for 循环划分成多个块, 每个块分配给不同的线程, 除了索引是私有变量, 其他变量由所有线程共享.</p>
<p><img src="/img/Pictures/20221120142857.png" srcset="/img/loading.gif" lazyload alt=""></p>
</li>
<li>
<p>归约</p>
<ul>
<li>
<p>将每个并行线程中的一个或多个私有变量在并行区域结束时组合起来.</p>
</li>
<li>
<p>原因</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel</span><br>&#123;<br>	<span class="hljs-type">int</span> id = <span class="hljs-built_in">omp_get_thread_num</span>();<br>	sum += A[id];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>由于 sum 变量被每个线程共享, 且各个线程同时发生, 上述代码中会发生数据冲突.</p>
<p>如果将 sum 变量声明为私有变量:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for private (sum)</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">1</span>) &#123;<br>	sum += A[i];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时由于 sum 变量是私有变量, 每个线程都有一个 sum 变量的副本, 所以不会发生数据冲突, 但是当并行结束后, 其他线程的 sum 变量的副本直接消失, 最终只剩下主线程的 sum.</p>
<p>于是便有了归约操作.</p>
</li>
<li>
<p>语法:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp for reduction(Operation : Var)</span><br></code></pre></td></tr></table></figure>
<p>其中 Operation 为执行操作, 如 +, *, -, min, max, &amp; 等; Var 为变量名.</p>
</li>
<li>
<p>例如:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp for reduction(+ : sum)</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">1</span>) &#123;<br>	sum += A[i];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>并行结束后 sum = A[0] + A[1] + … + A[N - 1].</p>
</li>
</ul>
</li>
<li>
<p>时间测量</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">omp_get_wtime</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br></code></pre></td></tr></table></figure>
<p>返回从某一过去时刻开始到现在的时间, 所以可以通过对该函数的两次调用来得到中间经过的时间.</p>
<p>由于时间是每个线程测量的, 所以不能保证两个不同的线程测量的时间相同.</p>
</li>
<li>
<p>锁 (非必要不适用, 表明这里只有一个线程)</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp critical</span><br>&#123;<br>	... <span class="hljs-comment">//Only one thread is running at a time here</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p>例子:</p>
<p>并行 Hello World</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;omp.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> nthreads, tid;<br>	<span class="hljs-comment">/* Fork team of threads with private var tid */</span><br>	<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel private(tid)</span><br>	&#123;<br>		tid = <span class="hljs-built_in">omp_get_thread_num</span>();<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World from thread = %d\n&quot;</span>, tid);<br>		<span class="hljs-keyword">if</span> (tid == <span class="hljs-number">0</span>) &#123;<br>			nthreads = <span class="hljs-built_in">omp_get_num_threads</span>();<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Number of threads = %d\n&quot;</span>, nthreads);	<br>		&#125;<br>	&#125; <span class="hljs-comment">/* All threads join master and terminate */</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="锁">锁</h2>
<p>如果来自两个不同的线程的访存请求访问同一个位置, 且至少有一个是写, 且连续出现, 那么这两个存储访问形成了数据竞争.</p>
<p>当任务之间相互独立时, 并行执行更为容易, 但通常任务之间需要协作. 协作意味着一些任务正在写入其他任务必须读取的值, 需要知道任务何时完成写入以便其他任务安全地读出. 因此任务之间需要同步. 如果它们不同步, 则存在数据竞争, 程序结果会根据事件发生次序而改变, 即程序的结果难以预测.</p>
<p>由于数据冲突使得多线程的读写结果难以确定, 于是使用&quot;锁&quot;授予对区域的访问权限, 以便一次只能操作一个线程 (由于需要使所有的处理器都能够访问锁, 所以选择共享内存中的一个位置作为锁).</p>
<p>处理器读取锁并等待 (如果锁定) 或设置锁并进入关键部分 (例如内存)</p>
<ul>
<li>0 表示锁已解锁.</li>
<li>1 表示锁已锁定</li>
</ul>
<p>用 RISC-V 汇编语言表示如下:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">Get_lock:</span> # <span class="hljs-built_in">s0</span> -&gt; <span class="hljs-keyword">addr</span> of lock<br>	addi t1, <span class="hljs-built_in">x0</span>, <span class="hljs-number">1</span> # t1 = Locked value<br><br><span class="hljs-symbol">Loop:</span> <br>	lw t0, j0(<span class="hljs-built_in">s0</span>) # Load lock<br>	<span class="hljs-keyword">bne</span> t0, <span class="hljs-built_in">x0</span>, Loop # Loop <span class="hljs-meta">if</span> locked<br><br><span class="hljs-symbol">Lock:</span><br>	sw t1, <span class="hljs-number">0</span>(<span class="hljs-built_in">s0</span>) # Unlocked, so lock<br><br><span class="hljs-symbol">Unlock:</span><br>	sw <span class="hljs-built_in">x0</span>, <span class="hljs-number">0</span>(<span class="hljs-built_in">s0</span>) # Unlocked, store word<br></code></pre></td></tr></table></figure>
<p>但是如果只是用锁仍然会存在问题:</p>
<p><img src="/img/Pictures/20221120132321.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>线程 1 加载锁时得到的是未锁定, 在线程 1 未锁定锁之前, 线程 2 加载锁, 此时线程 2 也认为锁未锁定, 于是线程 1 和线程 2 同时对同一个地址进行写操作, 发生错误.</p>
<p>可见只有锁无法解决数据冲突.</p>
<p><strong>死锁</strong>: 一种系统状态, 在这种状态下, 由于所有东西都被锁定等待其他东西, 因此无法进行任何操作.</p>
<h2 id="硬件同步">硬件同步</h2>
<p>由于只给线程的线程增加锁不足以解决数据冲突,<br>
所以需要硬件支持来避免另一个线程对值的更改.</p>
<p>在多处理器中实现同步的关键是使用一组硬件原语 (Primitives), 能够使线程以原子的方式读写内存.</p>
<p>原子操作: 在内存单元的读写之间不允许对地址进行其他访问.</p>
<ul>
<li>
<p>RISC-V 中提供读/写对来实现同步:</p>
<ul>
<li>
<p>Load reserved:</p>
  <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">lr</span> rd, rs<br></code></pre></td></tr></table></figure>
<p>将 rs 指向的字加载到 rd 中, 并添加 reservation.</p>
</li>
<li>
<p>Store conditional:</p>
  <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">sc</span> rd, rs1, rs2<br></code></pre></td></tr></table></figure>
<p>仅当 reservation 有效时, 将 rs2 中的值存储到 rs1 指向的内存位置中, 并设置 rd:</p>
<ul>
<li>如果自 lr 开始地址所存储的值未改变, 返回 0 (成功).</li>
<li>如果自 lr 开始地址所存储的值发生改变, 返回非 0 数 (失败).</li>
</ul>
<p>如果失败, 不发生存储.</p>
</li>
</ul>
<p>此时可以结合锁来解决数据冲突:</p>
<p><img src="/img/Pictures/20221120133640.png" srcset="/img/loading.gif" lazyload alt=""></p>
  <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs armasm">	li t2, <span class="hljs-number">1</span><br><span class="hljs-symbol">Try:</span> <br>	<span class="hljs-built_in">lr</span> t1, <span class="hljs-built_in">s1</span><br>	<span class="hljs-keyword">bne</span> t1, <span class="hljs-built_in">x0</span>, Try<br>	sc t0, <span class="hljs-built_in">s1</span>, t2<br>	<span class="hljs-keyword">bne</span> t0, <span class="hljs-built_in">x0</span>, Try<br><br><span class="hljs-symbol">Locked:</span><br>	<span class="hljs-comment"># critical section</span><br><br><span class="hljs-symbol">Unlocked:</span><br>	sw <span class="hljs-built_in">x0</span>, <span class="hljs-number">0</span>(<span class="hljs-built_in">s1</span>)<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>原子内存操作</p>
  <figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">AMOSWAP</span> rd, rs2, (rs1)<br><span class="hljs-symbol">AMOADD</span> rd, rs2, (rs1)<br><span class="hljs-symbol">...</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Reference">Reference</h2>
<section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>CS61C Great Ideas in Computer Architecture: <a target="_blank" rel="noopener" href="https://inst.eecs.berkeley.edu/~cs61c/sp22/">https://inst.eecs.berkeley.edu/~cs61c/sp22/</a>
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="category-chain-item">计算机组成原理</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="print-no-link">#计算机组成原理</a>
      
        <a href="/tags/CS61C/" class="print-no-link">#CS61C</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/07/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="操作系统">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">操作系统</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/07/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E7%BC%96%E8%AF%91%E5%99%A8-%E6%B1%87%E7%BC%96%E5%99%A8-%E9%93%BE%E6%8E%A5%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E5%99%A8/" title="编译器, 汇编器, 链接器和加载器">
                        <span class="hidden-mobile">编译器, 汇编器, 链接器和加载器</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
